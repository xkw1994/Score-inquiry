<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>å‡¯æ–‡è€å¸ˆdeâœ¨é­”æ³•æˆç»©å±‹âœ¨</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœ¨</text></svg>">
    
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        /* ==================== 
           1. å…¨å±€å¸ƒå±€ä¸èƒŒæ™¯ 
           ==================== */
        body { 
            /* èƒŒæ™¯è‰²ï¼šç»å…¸çš„æš–è‰²åˆ°ç´«è‰²çš„æ¸å˜ */
            background-image: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%); 
            height: 100vh; /* å æ»¡å±å¹•é«˜åº¦ */
            display: flex; /* Flexå¸ƒå±€ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            font-family: -apple-system, sans-serif; /* ç³»ç»Ÿé»˜è®¤å­—ä½“ */
            margin: 0; 
            overflow: hidden; /* ç¦æ­¢é¡µé¢æ»šåŠ¨ */
            -webkit-tap-highlight-color: transparent; /* å»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
            position: relative;
        }

        /* é­”æ³•å°˜åŸƒèƒŒæ™¯å±‚ï¼šå¢åŠ æ°›å›´æ„Ÿçš„åŠ¨æ€ç²’å­èƒŒæ™¯ */
        .magic-dust {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* ä½¿ç”¨å¾„å‘æ¸å˜æ¨¡æ‹Ÿå¾®å°çš„åœ†ç‚¹ */
            background-image: radial-gradient(rgba(255,255,255,0.4) 1px, transparent 1px);
            background-size: 50px 50px; /* æ§åˆ¶ç‚¹çš„å¯†åº¦ */
            opacity: 0.5; 
            z-index: 1; 
            pointer-events: none; /* ç¡®ä¿ä¸é˜»æŒ¡é¼ æ ‡ç‚¹å‡» */
            animation: twinkle 6s infinite linear; /* é—ªçƒç§»åŠ¨åŠ¨ç”» */
        }
        /* èƒŒæ™¯ç²’å­å‘ä¸Šæ¼‚æµ®å¹¶é—ªçƒçš„åŠ¨ç”» */
        @keyframes twinkle { 
            0% { transform: translateY(0); opacity: 0.3; } 
            50% { opacity: 0.7; } 
            100% { transform: translateY(-30px); opacity: 0.3; } 
        }

        /* ==================== 
           2. é¡¶éƒ¨æ»šåŠ¨æˆ˜æŠ¥æ  
           ==================== */
        .ticker-container {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 650px; height: 80px;
            /* æ¯›ç»ç’ƒç‰¹æ•ˆ */
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(12px);
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.4); 
            z-index: 100; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
            display: flex; flex-direction: column; justify-content: space-evenly;
            /* å·¦å³ä¸¤ä¾§æ¸éšé®ç½©ï¼Œè®©æ»šåŠ¨çœ‹èµ·æ¥æ›´è‡ªç„¶ */
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            opacity: 0; transition: opacity 0.5s; /* åˆå§‹éšè—ï¼Œæœ‰æ•°æ®æ—¶æ˜¾ç¤º */
        }
        .ticker-active { opacity: 1; }
        
        /* æ¯ä¸€è¡Œæ»šåŠ¨çš„å®¹å™¨ */
        .ticker-row { display: flex; gap: 16px; width: max-content; align-items: center; will-change: transform; height: 30px; }
        
        /* é¡¶éƒ¨è¡Œå‘å³æ»šï¼Œåº•éƒ¨è¡Œå‘å·¦æ»š */
        .row-top { transform: translateX(-100%); animation: scrollLeftToRight 25s linear infinite; }
        .row-bottom { transform: translateX(100vw); animation: scrollRightToLeft 30s linear infinite; }
        
        /* é¼ æ ‡æŒ‰ä½æ—¶æš‚åœæ»šåŠ¨ */
        .ticker-container:active .ticker-row { animation-play-state: paused; }

        @keyframes scrollLeftToRight { 0% { transform: translateX(-100%); } 100% { transform: translateX(100vw); } }
        @keyframes scrollRightToLeft { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        /* æˆ˜æŠ¥å°èƒ¶å›Šæ ·å¼ */
        .t-pill { 
            display: flex; align-items: center; gap: 6px; 
            padding: 3px 10px 3px 4px; border-radius: 30px; 
            background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
            font-size: 11px; font-weight: 600; color: #555; white-space: nowrap; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¼¹å‡ºåŠ¨ç”» */
        }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        
        /* èƒ¶å›Šå·¦ä¾§çš„ Emoji åœ†åœˆ */
        .emoji-box { width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 13px; color: #fff; }
        
        /* æ ¹æ®æˆç»©ç­‰çº§æ˜¾ç¤ºä¸åŒé¢œè‰² */
        .s-tier .emoji-box { background: linear-gradient(135deg, #ffd700, #fdb931); } /* é‡‘è‰² */
        .a-tier .emoji-box { background: linear-gradient(135deg, #10b981, #34d399); } /* ç»¿è‰² */
        .b-tier .emoji-box { background: linear-gradient(135deg, #3b82f6, #60a5fa); } /* è“è‰² */
        .c-tier .emoji-box { background: #9ca3af; } /* ç°è‰² */

        /* ==================== 
           3. ä¸»å¡ç‰‡åŒºåŸŸ 
           ==================== */
        .card { 
            background: rgba(255, 255, 255, 0.94); 
            padding: 25px 30px 70px 30px; /* åº•éƒ¨ padding è¾ƒå¤§ï¼Œä¸ºäº†ä¸è®©è¾“å…¥æ¡†æŒ¡ä½ç‰ˆæƒæ–‡å­— */
            border-radius: 28px; 
            box-shadow: 0 15px 45px rgba(0,0,0,0.1); 
            text-align: center; 
            width: 320px; 
            position: relative; 
            z-index: 10; 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            margin-top: 40px; /* æ•´ä½“ä½ç½®å¾®è°ƒ */
        }
        h1 { color: #ff6b81; font-size: 24px; margin-bottom: 5px; letter-spacing: 1px; }
        p.subtitle { color: #a4b0be; font-size: 13px; margin-bottom: 18px; }
        
        /* çŠ¶æ€ä¿¡æ¯æ  (æ•°æ®åº“/è®¿é—®é‡/åœ¨çº¿) */
        .system-status { 
            display: flex; justify-content: center; align-items: center; 
            gap: 8px; font-size: 10px; color: #8395a7; 
            margin-bottom: 25px; background: #f8f9fa; 
            padding: 7px 12px; border-radius: 50px; 
            border: 1px solid #eeeff1; 
        }
        .status-item { display: flex; align-items: center; gap: 5px; line-height: 1; }
        .data-num { font-weight: 600; color: #2f3542; }
        
        /* åœ¨çº¿äººæ•°ç»¿ç‚¹å‘¼å¸åŠ¨ç”» */
        .live-dot { 
            width: 6px; height: 6px; background-color: #2ecc71; border-radius: 50%; 
            box-shadow: 0 0 5px rgba(46, 204, 113, 0.6); animation: pulse 2.5s infinite; 
        }
        @keyframes pulse { 
            0% { opacity: 0.4; transform: scale(0.9); } 
            50% { opacity: 1; transform: scale(1.1); } 
            100% { opacity: 0.4; transform: scale(0.9); } 
        }
        
        /* ==================== 
           4. è¾“å…¥æ¡†ä¸æŒ‰é’® 
           ==================== */
        .input-group { margin-bottom: 15px; }
        
        input { 
            width: 85%; 
            padding: 13px; 
            border: 1.5px solid #f1f2f6; 
            border-radius: 14px; 
            outline: none; 
            font-size: 16px; 
            
            /* --- æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿æ–‡å­—å’Œè¾“å…¥æ¡†å®Œç¾å±…ä¸­ --- */
            text-align: center;   /* æ–‡å­—æ°´å¹³å±…ä¸­ */
            display: block;       /* å—çº§å…ƒç´  */
            margin: 0 auto;       /* è¾“å…¥æ¡†è‡ªèº«æ°´å¹³å±…ä¸­ */
            line-height: normal;  /* ä¿®å¤ iOS ä¸Šå…‰æ ‡é”™ä½ */
            
            transition: all 0.3s; 
            -webkit-appearance: none; /* å»é™¤åŸç”Ÿæ ·å¼ */
        }
        input:focus { border-color: #ff9a9e; } /* èšç„¦å˜è‰² */
        
        /* é”™è¯¯æ—¶çš„æŠ–åŠ¨åŠ¨ç”»ç±» */
        .shake { animation: shake 0.4s ease-in-out; border-color: #ff6b81 !important; box-shadow: 0 0 8px rgba(255, 107, 129, 0.3); }
        @keyframes shake { 
            0% { transform: translateX(0); } 
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 
            20%, 40%, 60%, 80% { transform: translateX(5px); } 
        }

        button { 
            width: 90%; margin-top: 10px; 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); 
            border: none; padding: 13px 0; border-radius: 50px; 
            color: white; font-weight: bold; font-size: 16px; 
            cursor: pointer; transition: transform 0.2s; -webkit-appearance: none; 
        }
        button:active { transform: scale(0.97); } /* ç‚¹å‡»ç¼©æ”¾ */
        
        /* ==================== 
           5. æŸ¥è¯¢ç»“æœåŒºåŸŸ 
           ==================== */
        .result-area { margin-top: 25px; padding: 20px; border-radius: 18px; display: none; line-height: 1.8; transition: all 0.5s; }
        .student-name { font-size: 19px; font-weight: bold; color: #2f3542; margin-bottom: 8px; }
        .honor-title { font-size: 14px; font-weight: bold; margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* ä¸åŒç­‰çº§çš„æˆç»©å•æ ·å¼ (æœå†»å¼¹è·³å‡ºç°åŠ¨ç”» jelly) */
        .rank-s { background: linear-gradient(135deg, #fffcf2 0%, #fff7d1 100%); border: 2px solid #ffd700; color: #854d0e; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); animation: jelly 0.6s forwards; }
        .rank-a { background: linear-gradient(135deg, #f0fff4 0%, #d1fae5 100%); border: 2px solid #10b981; color: #065f46; animation: jelly 0.6s forwards; }
        .rank-b { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #3b82f6; color: #1e40af; animation: jelly 0.6s forwards; }
        .rank-c { background: #f9fafb; border: 2px dashed #9ca3af; color: #4b5563; animation: jelly 0.6s forwards; }
        @keyframes jelly { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* åº•éƒ¨ç‰ˆæƒä¿¡æ¯ */
        .copyright { 
            position: absolute; bottom: 25px; left: 0; width: 100%;
            font-size: 11px; color: #ff6b81; font-weight: 600; opacity: 0.8; 
        }
        
        /* ==================== 
           6. é€šçŸ¥ä¸å¼¹å¹•ç³»ç»Ÿ 
           ==================== */
        /* å³ä¸‹è§’é€šçŸ¥å®¹å™¨ */
        #notification-container { position: fixed; bottom: 85px; right: 20px; z-index: 999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        /* å…·ä½“çš„é€šçŸ¥æ¡æ ·å¼ (æ»‘å…¥ -> åœç•™ -> ä¸Šæµ®æ¶ˆå¤±) */
        .toast { 
            background: rgba(255, 255, 255, 0.95); padding: 10px 18px; border-radius: 50px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-size: 12px; color: #555; 
            border-left: 4px solid #2ecc71; display: flex; align-items: center; gap: 8px; 
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.5s 3.5s forwards; 
            backdrop-filter: blur(5px); 
        }
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(20px); } }

        /* åº•éƒ¨å›ºå®šå¼¹å¹•è¾“å…¥æ  */
        .dm-bar { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); 
            width: 88%; max-width: 350px; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); 
            padding: 8px 8px 8px 15px; border-radius: 50px; 
            display: flex; align-items: center; gap: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6); 
            z-index: 999; transition: transform 0.3s; 
        }
        /* é”®ç›˜å¼¹èµ·æ—¶ç¨å¾®ä¸Šç§»ï¼Œé˜²æ­¢è¢«é®æŒ¡ï¼ˆéƒ¨åˆ†æµè§ˆå™¨æœ‰æ•ˆï¼‰ */
        .dm-bar:focus-within { transform: translateX(-50%) translateY(-5px); }
        .dm-input { flex: 1; border: none; background: transparent; outline: none; font-size: 15px; color: #555; text-align: left; padding: 0; width: auto; }
        .dm-btn { width: auto; margin: 0; padding: 8px 18px; font-size: 13px; background: #2ecc71; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); border-radius: 30px; }
        
        /* é£˜è¿‡çš„å¼¹å¹•æ ·å¼ */
        .dm-item { 
            position: fixed; white-space: nowrap; font-weight: bold; font-size: 18px; 
            text-shadow: 1.5px 1.5px 3px rgba(0,0,0,0.3); pointer-events: none; 
            z-index: 2000; left: 0; 
            animation: fly linear forwards; /* åŒ€é€Ÿé£è¿‡ */
            font-family: "YouYuan", "å¹¼åœ†", "Mini", "Comic Sans MS", sans-serif; 
        }
        @keyframes fly { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }
    </style>
</head>
<body>
    <div class="magic-dust"></div>

    <div class="ticker-container" id="tickerContainer">
        <div class="ticker-row row-top" id="trackTop"></div>
        <div class="ticker-row row-bottom" id="trackBottom"></div>
    </div>

    <div id="notification-container"></div>

    <div class="card">
        <h1>ğŸ° æœŸæœ«æˆç»©æŸ¥è¯¢</h1>
        <p class="subtitle">è¯·è¾“å…¥å§“åå’Œç”Ÿæ—¥å¬å”¤æˆç»©å•</p>
        
        <div class="system-status">
            <div class="status-item"><span>â¬¢ æ•°æ®åº“å·²åŒæ­¥ <span id="dataCount" class="data-num">0</span> äºº</span></div>
            <div style="width:1px; height:10px; background:#e0e0e0;"></div>
            <div class="status-item"><span>è®¿é—® <span id="busuanzi_value_page_pv" class="data-num">...</span></span></div>
            <div style="width:1px; height:10px; background:#e0e0e0;"></div>
            <div class="status-item">
                <div class="live-dot"></div>
                <span>åœ¨çº¿ <span id="onlineCount" class="data-num">1</span></span>
            </div>
        </div>
        
        <div class="input-group"><input type="text" id="nameInput" placeholder="è¾“å…¥å§“å" enterkeyhint="next"></div>
        <div class="input-group"><input type="tel" id="birthInput" placeholder="4ä½ç”Ÿæ—¥ (å¦‚: 0101)" maxlength="4" enterkeyhint="go"></div>
        
        <button id="searchBtn" onclick="checkGrade()">âœ¨ æŸ¥è¯¢ âœ¨</button>
        
        <div id="result" class="result-area">
            <div id="nameDisplay" class="student-name"></div>
            <div id="scoreDisplay"></div>
            <div id="honorDisplay"></div>
        </div>
        
        <div class="copyright">&copy; 2026 Designed by Kevin</div>
    </div>

    <div class="dm-bar">
        <input type="text" id="dmInput" class="dm-input" placeholder="å‘é€å¼¹å¹•..." maxlength="20" enterkeyhint="send" onkeypress="if(event.keyCode==13) sendDanmaku()">
        <button class="dm-btn" onclick="sendDanmaku()">å‘é€</button>
    </div>

    <script>
        // ==========================================
        // 1. æœ¬åœ°æ•°æ®åº“ (åŒ…å«å§“åã€ç”Ÿæ—¥å¯†ç ã€å„ç§‘æˆç»©)
        // æ ¼å¼ï¼š[å§“å, ç”Ÿæ—¥, è¯­æ–‡, æ•°å­¦, è‹±è¯­]
        // ==========================================
        const rawData = [
            ["è‚–å‡¯æ–‡", "1120", 93.5, 94, 94.5], ["é™ˆå‡¯æ–‡", "1120", 81, 79, 85], ["åˆ˜å‡¯æ–‡", "1120", 71, 74, 74],
            ["å½­å‡¯æ–‡", "1120", 20, 30, 47.5], ["æ¨æ–‡æ“", "1208", 99.5, 96.5, 97.3], ["é™ˆå®‡æµ©", "0623", 79.5, 88, 28],
            ["é™ˆæ¢“ä»ª", "0920", 4, 7, 21.5], ["æˆ´è¯—å®¸", "1124", 35.5, 17.5, 19.5], ["é‚“æ¥šå’Œ", "0630", 32, 29, 22],
            ["é‚“æ’", "0523", 84.3, 93.5, 98], ["é‚“è‹åµ˜", "0401", 78.8, 93.5, 52], ["é‚“æ–°ä¹", "1001", 13, 39.5, 19.5],
            ["é¡¾è°­æµ©", "0225", 86.8, 90, 93.5], ["å®˜é–è£•", "1009", 41, 78.5, 56.8], ["ä½•æ³‰", "0725", 13, 62, 24],
            ["ä½•å’çŠ", "0311", 57, 75.5, 59], ["èƒ¡æµ©é‘«", "0407", 82.5, 97, 89.5], ["èƒ¡æ–‡å±±", "0721", 67.5, 76, 56.5],
            ["é»„å®¶å’Œ", "0630", 40.5, 20, 25.5], ["é»„é–è¯—", "0212", 90, 96, 99.5], ["é»„æ¢¦çµ", "0108", 77.3, 95, 54.5],
            ["é»„èƒœ", "0823", 18.5, 93, 23.5], ["é»„è‰³è", "0204", 87, 80, 92.5], ["é»„æ”¿çƒ¨", "0824", 42, 74, 24.5],
            ["é»„å­è‰¯", "0712", 79, 70, 76], ["å­”ç­ ç‘¶", "1221", 60, 82.5, 87.5], ["é‚é™æ€¡", "0824", 87.8, 97, 97.5],
            ["æå®‰å€ª", "0811", 76.3, 97, 82], ["æåšæ–‡", "1024", 61.5, 62.5, 28.5], ["æå˜‰è±ª", "0925", 20.5, 73.5, 26],
            ["æå˜‰ä¿Š", "1103", 72, 85.5, 73.8], ["æä¿Šè‰¯", "0201", 57.5, 65.5, 39.5], ["æåœ£æ ‡", "0925", 80.5, 76.5, 55.5],
            ["ææ€éœ–", "0906", 56.5, 66, 27], ["æå½¦å¿»", "0310", 79.5, 96, 89], ["å»–ç›ˆæ½", "0620", 80, 91, 92.5],
            ["æ—åšæ–‡", "0707", 26, 18, 20], ["æ—å˜‰æ°", "1228", 87.8, 87, 97], ["æ—å¿ƒæ€¡", "0320", 60.5, 71.5, 35],
            ["æ—æŒ¯è½©", "0226", 85.8, 99, 99.8], ["å‡Œé™æ€¡", "0629", 87.5, 95, 98.5], ["åˆ˜è¾°å®‡", "0422", 84.3, 33.5, 47.3],
            ["åˆ˜é¦¥æº", "0516", 62.5, 74, 34.5], ["åˆ˜å®¶æƒ", "1204", 54, 65.5, 43], ["åˆ˜èƒ½åº·", "0327", 42, 50, 28],
            ["åˆ˜æ¶¦ä¸œ", "0823", 62.5, 48, 37], ["åˆ˜æ™“å®‡", "1120", 72, 66, 53], ["åˆ˜æ¬£æ€¡", "0716", 66.5, 83, 23.5],
            ["åˆ˜å¦¤è£´", "0611", 84.5, 82.5, 92.3], ["åˆ˜è‚²é“­", "0208", 15, 10, 20]
        ];

        // åˆå§‹åŒ–å¤„ç†æ•°æ®
        const db = rawData.map(row => {
            // ç¡®ä¿ç”Ÿæ—¥æ˜¯4ä½æ•°ï¼ˆä¾‹å¦‚ 112 -> 0112ï¼Œè™½ç„¶ç›®å‰æ•°æ®çœ‹èµ·æ¥éƒ½æ˜¯å¯¹çš„ï¼Œä½†åŠ ä¸ªé˜²æŠ¤ï¼‰
            let b = String(row[1]).trim(); 
            if (b.length === 3) b = "0" + b;
            
            // è®¡ç®—æ€»åˆ†
            const t = parseFloat(row[2]) + parseFloat(row[3]) + parseFloat(row[4]);
            
            // è¿”å›ç»“æ„åŒ–å¯¹è±¡ï¼šn=å§“å, b=ç”Ÿæ—¥, s=æ ¼å¼åŒ–åçš„æˆç»©HTML, t=æ€»åˆ†
            return { 
                n: row[0], 
                b: b, 
                s: `è¯­æ–‡ï¼š${row[2]}<br>æ•°å­¦ï¼š${row[3]}<br>è‹±è¯­ï¼š${row[4]}<br><strong>æ€»åˆ†ï¼š${t.toFixed(1)}</strong>`, 
                t: t 
            };
        });

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ€»äººæ•°
        document.getElementById('dataCount').innerText = db.length;

        // ==========================================
        // 2. Supabase å®æ—¶åç«¯é…ç½®
        // ==========================================
        const supabaseUrl = 'https://ijyctklfafrnerowwgii.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqeWN0a2xmYWZybmVyb3d3Z2lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4OTc4NjEsImV4cCI6MjA4NTQ3Mzg2MX0._hYKSgibEQyhmyexM9V3R2Z5A0GesRBRSCwX3Ed77C8'; 
        
        let supabaseClient;
        let globalChannel = null;

        try {
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            }
        } catch (e) { console.error(e); }

        // ==========================================
        // 3. åŠ¨æ€æˆ˜æŠ¥ (é¡¶éƒ¨æ»šåŠ¨æ¡) é€»è¾‘
        // ==========================================
        const displayedNames = new Set(); // è®°å½•å·²æ˜¾ç¤ºçš„å§“åï¼Œé˜²æ­¢é‡å¤
        let toggleRow = true; // ç”¨äºäº¤æ›¿å°†æˆ˜æŠ¥æ·»åŠ åˆ°ä¸Šè¡Œæˆ–ä¸‹è¡Œ

        // æ ¹æ®åˆ†æ•°åˆ¤æ–­ç­‰çº§ï¼Œè¿”å›å¯¹åº”çš„ CSS ç±»å’Œ Emoji
        function getTierInfo(score) {
            if (score >= 270) return { cls: 's-tier', icon: 'ğŸ¥³' }; 
            if (score >= 240) return { cls: 'a-tier', icon: 'ğŸ˜Š' }; 
            if (score >= 210) return { cls: 'b-tier', icon: 'ğŸ˜±' }; 
            return { cls: 'c-tier', icon: 'ğŸ˜­' }; 
        }

        // æ·»åŠ ä¸€æ¡è®°å½•åˆ°æ»šåŠ¨æ 
        function addToTicker(name, score) {
            if (displayedNames.has(name)) return; // å¦‚æœå·²æ˜¾ç¤ºè¿‡ï¼Œåˆ™å¿½ç•¥
            displayedNames.add(name);
            
            // åªè¦æœ‰æ•°æ®ï¼Œå°±æ˜¾ç¤ºæ»šåŠ¨æ å®¹å™¨
            document.getElementById('tickerContainer').classList.add('ticker-active');
            
            const info = getTierInfo(score);
            const item = document.createElement('div');
            item.className = `t-pill ${info.cls}`; // åº”ç”¨ç­‰çº§æ ·å¼
            item.innerHTML = `<div class="emoji-box">${info.icon}</div> ${name} å·²æŸ¥è¯¢`;
            
            // äº¤æ›¿æ·»åŠ åˆ°ä¸Šä¸‹è½¨é“
            const trackId = toggleRow ? 'trackTop' : 'trackBottom';
            document.getElementById(trackId).appendChild(item);
            toggleRow = !toggleRow; 
        }

        // ==========================================
        // 4. å®æ—¶å¼¹å¹•é€»è¾‘
        // ==========================================
        
        // ç”¨æˆ·ç‚¹å‡»å‘é€æŒ‰é’®è§¦å‘
        async function sendDanmaku() {
            const input = document.getElementById('dmInput');
            const text = input.value.trim();
            if (!text) return;
            // é€šè¿‡ Supabase å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
            if (globalChannel) {
                await globalChannel.send({ type: 'broadcast', event: 'danmaku', payload: { text: text } });
                input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            }
        }

        // åœ¨å±å¹•ä¸Šç”Ÿæˆå¹¶ç§»åŠ¨å¼¹å¹• DOM å…ƒç´ 
        function shootDanmaku(text) {
            const el = document.createElement('div');
            el.innerText = text;
            el.className = 'dm-item'; // ä½¿ç”¨ CSS å®šä¹‰å¥½çš„åŠ¨ç”»ç±»
            
            // éšæœºé¢œè‰²
            const colors = ['#fff', '#ffeaa7', '#81ecec', '#fab1a0', '#a29bfe'];
            el.style.color = colors[Math.floor(Math.random() * colors.length)];
            
            // éšæœºé«˜åº¦ (30% - 70% å±å¹•ä½ç½®)
            el.style.top = Math.floor(Math.random() * 40 + 30) + '%';
            
            // éšæœºé£è¡Œé€Ÿåº¦
            el.style.animationDuration = Math.floor(Math.random() * 6 + 8) + 's';
            
            document.body.appendChild(el);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            el.addEventListener('animationend', () => { el.remove(); });
        }

        // ==========================================
        // 5. åˆå§‹åŒ–è¿æ¥ & çŠ¶æ€åŒæ­¥ (æ ¸å¿ƒè”ç½‘åŠŸèƒ½)
        // ==========================================
        async function initLiveCount() {
            if (!supabaseClient) return;
            
            // ç”Ÿæˆæˆ–è¯»å–ç”¨æˆ· ID (ç”¨äºç»Ÿè®¡åœ¨çº¿äººæ•°)
            let myId = localStorage.getItem('score_visitor_id') || ('user_' + Math.floor(Math.random() * 10000000));
            localStorage.setItem('score_visitor_id', myId);

            // åˆ›å»ºé¢‘é“ 'score_room'
            globalChannel = supabaseClient.channel('score_room', {
                config: { presence: { key: myId }, broadcast: { self: true } }
            });

            globalChannel
                // ç›‘å¬åœ¨çº¿çŠ¶æ€å˜åŒ–
                .on('presence', { event: 'sync' }, () => {
                    const state = globalChannel.presenceState();
                    // æ›´æ–°åœ¨çº¿äººæ•°
                    document.getElementById('onlineCount').innerText = Object.keys(state).length;
                    
                    // åŒæ­¥æ–°åŠ å…¥ç”¨æˆ·çš„â€œæœ€æ–°æŸ¥è¯¢çŠ¶æ€â€åˆ°æ»šåŠ¨æ 
                    Object.values(state).forEach(users => {
                        users.forEach(u => {
                            if (u.latest_check) {
                                addToTicker(u.latest_check.name, u.latest_check.score);
                            }
                        });
                    });
                })
                // ç›‘å¬å¹¿æ’­ï¼šæœ‰äººæŸ¥åˆ†æˆåŠŸ
                .on('broadcast', { event: 'check_success' }, (payload) => {
                    const { name, score } = payload.payload;
                    showToast("ğŸ‰ " + name + " å·²æŸ¥è¯¢æˆç»©"); // å³ä¸‹è§’å¼¹çª—é€šçŸ¥
                    if(score !== undefined) addToTicker(name, score); // æ·»åŠ åˆ°æ»šåŠ¨æ 
                })
                // ç›‘å¬å¹¿æ’­ï¼šæœ‰äººå‘å¼¹å¹•
                .on('broadcast', { event: 'danmaku' }, (payload) => {
                    shootDanmaku(payload.payload.text);
                })
                // è®¢é˜…é¢‘é“å¹¶è¿½è¸ªè‡ªå·±çš„åœ¨çº¿çŠ¶æ€
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') await globalChannel.track({ online_at: new Date().toISOString() });
                });
        }

        // æ˜¾ç¤ºå³ä¸‹è§’ Toast é€šçŸ¥
        function showToast(text) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>ğŸ””</span> ${text}`;
            container.appendChild(toast);
            // 1.2ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => { toast.remove(); }, 1200);
        }

        // ==========================================
        // 6. æ ¸å¿ƒé€»è¾‘ï¼šæŸ¥è¯¢æˆç»©ä¸åŠ¨ç”»
        // ==========================================
        
        // Sçº§åŠ¨ç”»ï¼šå·¦å³å–·å°„å½©å¸¦
        function animRankS() {
            var duration = 3000; var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ffd700', '#ff0000'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ffd700', '#ff0000'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }
        // Açº§åŠ¨ç”»ï¼šåº•éƒ¨å–·å°„ç»¿è‰²ç³»çº¸å±‘
        function animRankA() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#34d399', '#065f46'] }); }
        // Bçº§åŠ¨ç”»ï¼šæ˜Ÿæ˜Ÿå½¢çŠ¶
        function animRankB() {
            var defaults = { spread: 360, ticks: 50, gravity: 0, decay: 0.94, startVelocity: 30, shapes: ['star'], colors: ['#3b82f6', '#60a5fa', '#93c5fd'] };
            function shoot() { confetti({ ...defaults, particleCount: 40, scalar: 1.2, shapes: ['star'] }); confetti({ ...defaults, particleCount: 10, scalar: 0.75, shapes: ['circle'] }); }
            setTimeout(shoot, 0); setTimeout(shoot, 100); setTimeout(shoot, 200);
        }
        // Cçº§åŠ¨ç”»ï¼šç®€å•çš„ç°è‰²æ–¹å—æ‰è½
        function animRankC() {
             var end = Date.now() + 2000;
             (function frame() {
                confetti({ particleCount: 2, angle: 270, spread: 0, origin: { x: Math.random(), y: 0 }, colors: ['#9ca3af'], shapes: ['square'], gravity: 2, scalar: 0.8 });
                if (Date.now() < end) requestAnimationFrame(frame);
             }());
        }

        // ç‚¹å‡»â€œæŸ¥è¯¢â€æŒ‰é’®è§¦å‘çš„å‡½æ•°
        async function checkGrade() {
            const nameInput = document.getElementById('nameInput');
            const birthInput = document.getElementById('birthInput');
            
            const name = nameInput.value.trim();
            const birth = birthInput.value.trim();
            
            const resultDiv = document.getElementById('result');
            const nameDiv = document.getElementById('nameDisplay');
            const scoreDiv = document.getElementById('scoreDisplay');
            const honorDiv = document.getElementById('honorDisplay');
            
            // é‡ç½®æ˜¾ç¤ºåŒºåŸŸ
            resultDiv.className = "result-area"; resultDiv.style.display = "none";
            honorDiv.innerHTML = "";
            
            // è¡¨å•æ ¡éªŒï¼šä¸ºç©ºæ—¶è§¦å‘æŠ–åŠ¨åŠ¨ç”»
            if (!name) { nameInput.classList.add('shake'); setTimeout(() => nameInput.classList.remove('shake'), 400); return; }
            if (!birth) { birthInput.classList.add('shake'); setTimeout(() => birthInput.classList.remove('shake'), 400); return; }

            // æ¨¡æ‹ŸæçŸ­çš„æŸ¥è¯¢å»¶è¿Ÿ (50ms)ï¼Œé˜²æ­¢ç•Œé¢é—ªçƒå¤ªå¿«
            setTimeout(() => {
                resultDiv.style.display = "block";
                
                // åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾å§“å
                const studentByName = db.find(s => s.n === name);

                if (studentByName) {
                    // æ ¡éªŒç”Ÿæ—¥
                    if (studentByName.b === birth) {
                        // 1. éªŒè¯æˆåŠŸï¼Œæ˜¾ç¤ºæˆç»©
                        nameDiv.innerText = "ğŸ‰ " + studentByName.n + " åŒå­¦";
                        scoreDiv.innerHTML = studentByName.s;
                        document.getElementById('searchBtn').disabled = true; // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»

                        // 2. è”ç½‘å¹¿æ’­ï¼šå‘Šè¯‰å…¶ä»–äººâ€œæˆ‘æŸ¥å®Œäº†â€
                        if (globalChannel) {
                            globalChannel.send({ 
                                type: 'broadcast', event: 'check_success', 
                                payload: { name: studentByName.n, score: studentByName.t } 
                            });
                            // æ›´æ–°è‡ªå·±çš„çŠ¶æ€ï¼Œæ–°è¿›æ¥çš„äººèƒ½çœ‹åˆ°æˆ‘æŸ¥è¿‡äº†
                            globalChannel.track({
                                online_at: new Date().toISOString(),
                                latest_check: { name: studentByName.n, score: studentByName.t }
                            });
                        }

                        // 3. æ ¹æ®æ€»åˆ†å±•ç¤ºä¸åŒçš„ç‰¹æ•ˆå’Œç§°å·
                        if (studentByName.t >= 270) { 
                            resultDiv.classList.add("rank-s"); 
                            honorDiv.innerHTML = '<div class="honor-title" style="color:#854d0e">ğŸ‘‘ è£èª‰æ—¶åˆ»</div>';
                            animRankS(); 
                        }
                        else if (studentByName.t >= 240) { 
                            resultDiv.classList.add("rank-a"); 
                            honorDiv.innerHTML = '<div class="honor-title" style="color:#065f46">ğŸŒ¿ å“è¶Šæˆé•¿</div>';
                            animRankA(); 
                        }
                        else if (studentByName.t >= 210) { 
                            resultDiv.classList.add("rank-b"); 
                            honorDiv.innerHTML = '<div class="honor-title" style="color:#1e40af">âœ¨ æœªæ¥å¯æœŸ</div>';
                            animRankB(); 
                        }
                        else { 
                            resultDiv.classList.add("rank-c"); 
                            honorDiv.innerHTML = '<div class="honor-title" style="color:#4b5563">ğŸŒ± åšç§¯è–„å‘</div>';
                            animRankC(); 
                        }

                    } else {
                        // å§“åå¯¹ï¼Œç”Ÿæ—¥é”™
                        nameDiv.innerText = "ğŸ”’ éªŒè¯å¤±è´¥";
                        scoreDiv.innerHTML = "å§“åæ­£ç¡®ï¼Œä½†ç”Ÿæ—¥è¾“å…¥é”™è¯¯ã€‚<br>è¯·æ ¸å¯¹åé‡è¯• (ä¾‹å¦‚: 0101)ã€‚";
                        resultDiv.classList.add("rank-c");
                    }
                } else {
                    // å§“åä¸å­˜åœ¨
                    nameDiv.innerText = "ğŸš« æŸ¥æ— æ­¤äºº";
                    scoreDiv.innerHTML = "æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°è¯¥å§“åã€‚<br>è¯·æ£€æŸ¥æ˜¯å¦æœ‰é”™åˆ«å­—ã€‚";
                    resultDiv.classList.add("rank-c");
                }
            }, 50);
        }

        // é¡µé¢åŠ è½½å®Œæ¯•åï¼Œå¯åŠ¨è”ç½‘åŠŸèƒ½
        window.onload = initLiveCount;
    </script>
</body>
</html>
